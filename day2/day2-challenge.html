<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="assignment-type" content="type2" />
    <title>Day_2!</title>

    <script
      src="https://code.jquery.com/jquery-3.5.1.min.js"
      integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
      crossorigin="anonymous"
    ></script>

    <style type="text/css">
      body {
        /* 배그 시작 화면 배경 이미지 (예시 URL, 필요시 교체) */
        background: url("https://cdn.cloudflare.steamstatic.com/steam/apps/578080/page_bg_generated_v6b.jpg")
          no-repeat center center fixed;
        background-size: cover;
        min-height: 100vh;
        margin: 0;
      }
      .center-top-box {
        position: absolute;
        left: 50%;
        top: 5%;
        transform: translate(-50%, 0);
        background: rgba(255, 255, 255, 0.96);
        border-radius: 20px;
        box-shadow: 0 12px 36px rgba(0, 0, 0, 0.2);
        padding: 32px clamp(20px, 5vw, 48px);
        width: min(90vw, 480px);
        z-index: 10;
        text-align: center;
        backdrop-filter: blur(8px);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .center-top-box:hover {
        box-shadow: 0 16px 48px rgba(0, 0, 0, 0.3);
        transform: translate(-50%, -2px);
      }

      .center-top-box h1,
      .center-top-box h3 {
        margin: 0 0 14px 0;
        font-weight: 700;
        color: #222;
      }

      .center-top-box label {
        display: block;
        margin: 16px 0 8px;
        font-size: 0.95rem;
        color: #444;
        text-align: left;
      }

      .center-top-box input[type="text"] {
        padding: 10px 14px;
        border-radius: 10px;
        border: 1px solid #ccc;
        font-size: 1rem;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        transition: border-color 0.2s, box-shadow 0.2s;
      }

      .center-top-box input[type="text"]:focus {
        border-color: #0078d4;
        box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
        outline: none;
      }

      .center-top-box button {
        margin-top: 20px;
        padding: 12px 24px;
        border-radius: 12px;
        border: none;
        background: linear-gradient(135deg, #222, #444);
        color: #fff;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s ease, transform 0.2s ease;
      }

      .center-top-box button:hover:not(:disabled) {
        background: linear-gradient(135deg, #000, #333);
        transform: translateY(-2px);
      }

      .center-top-box button:disabled {
        background: #bbb;
        color: #eee;
        cursor: not-allowed;
      }

      .loading {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 8px;
        justify-content: center;
      }
      .hidden {
        display: none;
      }
      .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid #ccc;
        border-top-color: #333;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      ul#names-q1 {
        margin-top: 18px;
        padding: 0;
        list-style: none;
        text-align: left;
        font-size: 1rem;
      }
      ul#names-q1 li {
        margin-bottom: 6px;
        background: #f7f7f7;
        border-radius: 6px;
        padding: 7px 12px;
      }
      .bullet-btn {
        margin-top: 10px;
        padding: 8px 24px 8px 40px;
        border-radius: 30px;
        border: none;
        background: #222;
        color: #fff;
        font-size: 1rem;
        cursor: pointer;
        transition: background 0.2s;
        position: relative;
        font-weight: bold;
        outline: none;
      }
      .bullet-btn:disabled {
        background: #888;
        cursor: not-allowed;
      }
      .bullet-icon {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        width: 18px;
        height: 18px;
        fill: #ffd700;
        pointer-events: none;
      }
      .parachute {
        position: fixed;
        left: 0;
        pointer-events: auto; /* 클릭 가능하게 반드시 추가 */
        width: 120px;
        height: 160px;
        z-index: 2;
        opacity: 0.85;
        animation: fall linear forwards;
      }
      @keyframes fall {
        to {
          top: 110vh;
          /* left는 JS에서 동적으로 변경 */
        }
      }
      @media (max-width: 500px) {
        .center-top-box {
          padding: 16px 4vw 12px 4vw;
          min-width: 0;
        }
        .center-top-box input[type="text"] {
          width: 90%;
          max-width: none;
        }
      }
      #go-play-btn {
        display: none;
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%) scale(0.5);
        background: url("https://cdn.cloudflare.steamstatic.com/steam/apps/578080/header.jpg")
          center/cover no-repeat;
        border: none;
        border-radius: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.35);
        color: #fff;
        font-size: 2.2rem;
        font-weight: bold;
        padding: 48px 80px;
        cursor: pointer;
        z-index: 2000;
        transition: transform 0.5s cubic-bezier(0.4, 2, 0.6, 1), opacity 0.5s;
        opacity: 0.95;
        outline: none;
        text-shadow: 2px 2px 8px #222, 0 0 16px #000;
        letter-spacing: 2px;
      }
      #go-play-btn.show {
        display: block;
        animation: growBtn 0.7s cubic-bezier(0.4, 2, 0.6, 1) forwards;
      }
      @keyframes growBtn {
        0% {
          transform: translate(-50%, -50%) scale(0.5);
          opacity: 0.2;
        }
        60% {
          transform: translate(-50%, -50%) scale(1.15);
          opacity: 1;
        }
        100% {
          transform: translate(-50%, -50%) scale(1);
          opacity: 1;
        }
      }
      @keyframes shake {
        0% {
          transform: translate(-50%, 0);
        }
        20% {
          transform: translate(
            calc(-50% + var(--shake-x, 0px)),
            calc(var(--shake-y, 0px))
          );
        }
        40% {
          transform: translate(
            calc(-50% - var(--shake-x, 0px)),
            calc(-1 * var(--shake-y, 0px))
          );
        }
        60% {
          transform: translate(
            calc(-50% + var(--shake-x2, 0px)),
            calc(var(--shake-y2, 0px))
          );
        }
        80% {
          transform: translate(
            calc(-50% - var(--shake-x2, 0px)),
            calc(-1 * var(--shake-y2, 0px))
          );
        }
        100% {
          transform: translate(-50%, 0);
        }
      }
      .shake {
        animation: shake 120ms linear;
      }
      .pan-tilt {
        animation: pan-tilt-anim 0.7s cubic-bezier(0.7, -0.5, 0.3, 1.7) 0s 4
          alternate;
      }
      @keyframes pan-tilt-anim {
        0% {
          transform: scaleX(-1) rotate(0deg);
        }
        30% {
          transform: scaleX(-1) rotate(30deg);
        }
        60% {
          transform: scaleX(-1) rotate(-18deg);
        }
        80% {
          transform: scaleX(-1) rotate(10deg);
        }
        100% {
          transform: scaleX(-1) rotate(0deg);
        }
      }

      #pan-loading-img {
        transform: scaleX(-1);
      }
    </style>

    <script>
      function q1() {
        $("#names-q1").empty();

        const playerName = $("#player-name").val().trim();
        const platformRaw = $("#platform").val().trim().toLowerCase();
        const shardMap = {
          steam: "steam",
          스팀: "steam",
          tmxla: "steam",
          스침: "steam",
          stim: "steam",
          kakao: "kakao",
          카카오: "kakao",
          카카오톡: "kakao",
          psn: "psn",
          플스: "psn",
          xbox: "xbox",
          엑박: "xbox",
        };
        const platform = shardMap[platformRaw] || platformRaw;

        const apiKey =
          "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJqdGkiOiJlZDliMjc1MC01OTcyLTAxM2UtNWY3MS03NmNhZDljYTc2ODYiLCJpc3MiOiJnYW1lbG9ja2VyIiwiaWF0IjoxNzU0OTc5ODcwLCJwdWIiOiJibHVlaG9sZSIsInRpdGxlIjoicHViZyIsImFwcCI6Ii05NzUwYzczNy05MWU0LTQxZTctYjVkMy1lMWVmMDc2MGVkYWYifQ.wzPMT07l_4WHcC2lMVSIx9cVhMTOBys0GI54BB9gbmY";

        if (!playerName || !platform) {
          alert("닉네임과 플랫폼을 모두 입력하세요.");
          return;
        }
        const allowed = ["steam", "kakao", "psn", "xbox"];
        if (!allowed.includes(platform)) {
          $("#names-q1").append(`<li>지원하지 않는 플랫폼: ${platform}</li>`);
          return;
        }

        const headers = {
          Authorization: `Bearer ${apiKey}`,
          Accept: "application/vnd.api+json",
        };
        $.ajax({
          type: "GET",
          url: `https://api.pubg.com/shards/${platform}/players`,
          headers,
          data: { "filter[playerNames]": playerName },
          success: function (response) {
            const player = response.data[0];
            const name = player.attributes.name;
            const shardId = player.attributes.shardId;
            const playerId = player.id;

            $.ajax({
              type: "GET",
              url: `https://api.pubg.com/shards/${platform}/players/${playerId}/seasons/lifetime`,
              headers,
              success: function (response) {
                console.log(response);
                let stats = response?.data?.attributes?.gameModeStats || {};
                let sum = { kills: 0, wins: 0, rounds: 0, time: 0 };

                for (let mode of Object.keys(stats)) {
                  let m = stats[mode];
                  if (!m) continue;
                  sum.kills += m.kills || 0;
                  sum.wins += m.wins || 0;
                  sum.rounds += m.roundsPlayed || 0;
                  sum.time += m.timeSurvived || 0;
                }

                const deaths = sum.rounds - sum.wins;
                const kd = deaths ? sum.kills / deaths : sum.kills;
                const avgSec = sum.rounds ? sum.time / sum.rounds : 0;

                const resultList = [
                  `플레이어 이름: ${name}`,
                  `플랫폼: ${shardId}`,
                  `총 경기 수: ${sum.rounds.toLocaleString()}`,
                  `승리 횟수: ${sum.wins.toLocaleString()}`,
                  `킬/데스 비율(K/D): ${kd.toFixed(2)}`,
                  `평균 생존 시간: ${avgTime(avgSec)}`,
                ];
                showListAnimated(resultList);
              },
              error: function () {
                $("#loading").addClass("hidden");
                const $btn = $("#search-button");
                $btn.prop("disabled", false).text($btn.data("orig") || "검색");
                $("#names-q1").append(
                  "<li>플레이어 정보를 불러오는 중 오류가 발생했습니다.</li>"
                );
              },
            });
          },
          error: function () {
            $("#loading").addClass("hidden");
            const $btn = $("#search-button");
            $btn.prop("disabled", false).text($btn.data("orig") || "검색");
            $("#names-q1").append(
              "<li>플레이어 정보를 불러오는 중 오류가 발생했습니다.</li>"
            );
          },
          statusCode: {
            404: function (xhr) {
              $("#names-q1").append(
                "<li>해당 플레이어를 찾을 수 없습니다. (404에러)</li>"
              );
              $("#loading").addClass("hidden");
              const $btn = $("#search-button");
              $btn.prop("disabled", false).text($btn.data("orig") || "검색");
            },
          },
        });

        function avgTime(timeInSeconds) {
          if (timeInSeconds > 3600) {
            const hours = Math.floor(timeInSeconds / 3600);
            const minutes = Math.floor((timeInSeconds % 3600) / 60);
            const seconds = Math.floor(timeInSeconds % 60);
            return `${hours}시간 ${String(minutes).padStart(2, "0")}분 ${String(
              seconds
            ).padStart(2, "0")}초`;
          } else if (timeInSeconds > 60) {
            const minutes = Math.floor(timeInSeconds / 60);
            const seconds = Math.floor(timeInSeconds % 60);
            return `${minutes}분 ${String(seconds).padStart(2, "0")}초`;
          } else {
            return `${Math.floor(timeInSeconds)}초`;
          }
        }

        function showListAnimated(list) {
          const $ul = $("#names-q1");
          $ul.empty();
          let delay = 0;
          const bulletImgUrl = "pngegg.png"; // 총알 이미지 파일명(실제 파일명으로 교체)

          // div 박스의 실제 넓이 계산
          const boxWidth = $(".center-top-box").outerWidth() || 400;

          list.forEach((html, idx) => {
            setTimeout(() => {
              // 총알 이미지와 텍스트를 감싼 div 생성
              const $li = $("<li>").css({
                display: "flex",
                alignItems: "center",
                gap: "12px",
                background: "none",
                borderRadius: "0",
                padding: "0",
                marginBottom: "12px",
                opacity: 0,
                // 우측 화면 밖에서 시작, 박스 넓이만큼 이동
                transform: `translateX(${boxWidth}px)`,
                transition:
                  "opacity 0.5s, transform 0.7s cubic-bezier(.4,2,.6,1)",
              });
              const $img = $("<img>")
                .attr("src", bulletImgUrl)
                .attr("alt", "총알")
                .css({
                  width: "32px",
                  height: "32px",
                  flexShrink: 0,
                });
              const $text = $("<span>").html(html).css({
                fontSize: "1rem",
                color: "#222",
                fontWeight: "bold",
              });
              $li.append($img).append($text);
              $ul.append($li);
              $(".center-top-box").css("height", "auto");
              setTimeout(() => {
                $li.css({
                  opacity: 1,
                  transform: "translateX(0)", // 박스 넓이만큼 좌로 이동
                });
              }, 50);
            }, delay);
            delay += 350;
          });
        }
      }
    </script>

    <script>
      $(function () {
        const panNormal = "pen.png";
        const panLoading = "pen_normal.png";

        // 로딩 애니메이션 제어 함수
        function startLoadingAnim() {
          const $img = $("#pan-loading-img");
          $img.addClass("pan-tilt");
        }
        function stopLoadingAnim() {
          const $img = $("#pan-loading-img");
          $img.removeClass("pan-tilt");
        }

        // 검색 버튼에 마우스 올리면 후라이팬 이미지 변경
        $("#search-button").on("mouseenter", function () {
          $("#pan-img").attr("src", panLoading);
        });
        $("#search-button").on("mouseleave", function () {
          $("#pan-img").attr("src", panNormal);
        });

        // ajaxStart에서 3초간 로딩
        $(document).ajaxStart(function () {
          $("#loading").removeClass("hidden");
          const $btn = $("#search-button");
          $btn.prop("disabled", true);
          $("#pan-img").attr("src", panLoading);
          startLoadingAnim();
          setTimeout(function () {
            $(document).trigger("ajaxStop");
          }, 3000);
        });

        $(document).ajaxStop(function () {
          $("#loading").addClass("hidden");
          const $btn = $("#search-button");
          $btn.prop("disabled", false);
          $("#pan-img").attr("src", panNormal);
          stopLoadingAnim();
        });

        $(document).ajaxError(function () {
          $("#loading").addClass("hidden");
          const $btn = $("#search-button");
          $btn.prop("disabled", false);
          $("#pan-img").attr("src", panNormal);
          stopLoadingAnim();
        });
      });
    </script>
  </head>

  <body>
    <!-- 배경음악 자동 재생 (반복) -->
    <audio
      id="bgm"
      src="Alan Walker, Sabrina Carpenter & Farruko  - On My Way.mp3"
      loop
      hidden
    ></audio>
    <div id="parachute-area"></div>
    <!-- 킬 카운트 표시 -->
    <div
      id="kill-counter"
      style="
        position: fixed;
        top: 24px;
        right: 36px;
        z-index: 1000;
        font-size: 2rem;
        font-weight: bold;
        color: #fff;
        text-shadow: 2px 2px 8px #222;
        user-select: none;
        pointer-events: none;
        display: none; /* 처음에는 안 보이게 */
      "
    >
      KILL : <span id="kill-count">0</span>
    </div>
    <!-- 게임 하러 가기 버튼 -->
    <button
      id="go-play-btn"
      onclick="window.open('https://pubg.com/', '_blank')"
    >
      게임 하러 가기
    </button>

    <!-- 전적검색하기 시작 버튼 (화면 중앙, 배그 배경) -->
    <button
      id="start-search-btn"
      style="
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        background: url('https://cdn.cloudflare.steamstatic.com/steam/apps/578080/header.jpg')
          center/cover no-repeat;
        border: none;
        border-radius: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.35);
        color: #fff;
        font-size: 2.2rem;
        font-weight: bold;
        padding: 48px 80px;
        cursor: pointer;
        z-index: 3000;
        outline: none;
        text-shadow: 2px 2px 8px #222, 0 0 16px #000;
        letter-spacing: 2px;
      "
    >
      전적검색하기
    </button>

    <!-- 전적검색하기 입력 박스 (처음에는 숨김) -->
    <div class="center-top-box" style="display: none; position: relative;">
      <!-- 크롤러 레이어 추가 -->
      <div class="crawler-layer" id="crawler-layer" aria-hidden="true"
        style="position:absolute; inset:0; pointer-events:none; z-index: 15;"></div>
      <img
        src="pngwing.com.png"
        alt="PUBG 로고"
        style="width: 360px; max-width: 120vw; display: block; margin: 0 auto 12px auto;"
      />
      <label><input type="text" id="player-name" placeholder="닉네임" /></label>
      <label><input type="text" id="platform" placeholder="플랫폼" /></label>
      <!-- 검색 버튼을 후라이팬 이미지로 변경 -->
      <button
        id="search-button"
        class="bullet-btn"
        onclick="q1()"
        style="padding: 0 0 0 0; background: none; border: none"
      >
        <img
          id="pan-img"
          src="pen.png"
          alt="검색(후라이팬)"
          style="width: 72px; height: 72px; vertical-align: middle"
        />
      </button>
      <div id="loading" class="loading hidden">
        <!-- 로딩 중에는 발사하는 총 이미지로 변경 -->
        <img
          id="pan-loading-img"
          src="military-icon-png-19288.png"
          alt="로딩(발사하는 총)"
          style="width: 32px; height: 32px; vertical-align: middle"
        />
        <span>불러오는 중…</span>
      </div>
      <!-- 결과 출력 영역 -->
      <ul id="names-q1"></ul>
    </div>

    <script>
      // 낙하산 PNG 이미지 (현재 파일과 동일 폴더에 위치)
      const parachuteImgUrl = "pngimg.com - parachute_PNG19426.png";
      let killCount = 0;
      let goPlayShown = false;

      function showExplosion(x, y, size = 120) {
        const explosion = document.createElement("img");
        explosion.src = "ChatGPT Image 2025년 8월 12일 오후 08_19_01.png"; // 임의의 투명 배경 폭발 PNG
        explosion.alt = "폭발";
        explosion.style.position = "fixed";
        explosion.style.left = x - size / 2 + "px";
        explosion.style.top = y - size / 2 + "px";
        explosion.style.width = size + "px";
        explosion.style.height = size + "px";
        explosion.style.pointerEvents = "none";
        explosion.style.zIndex = 9999;
        explosion.style.opacity = 0.95;
        explosion.style.transition = "opacity 0.5s";
        document.body.appendChild(explosion);
        setTimeout(() => {
          explosion.style.opacity = 0;
          setTimeout(() => explosion.remove(), 500);
        }, 350);
      }

      function spawnParachute() {
        const area = document.getElementById("parachute-area");
        const parachute = document.createElement("img");
        parachute.className = "parachute";
        parachute.src = parachuteImgUrl;
        parachute.alt = "낙하산";
        parachute.style.pointerEvents = "auto"; // ★ 클릭 가능하게 명시

        // 2~5배 랜덤 크기
        const scale = 2 + Math.random() * 3; // 2~5
        const baseWidth = 60,
          baseHeight = 80;
        const width = baseWidth * scale;
        const height = baseHeight * scale;
        parachute.style.width = width + "px";
        parachute.style.height = height + "px";
        parachute.style.top = -height + "px";

        // 시작 left 위치 (0 ~ 화면 너비 - width)
        const startLeft = Math.random() * (window.innerWidth - width);
        parachute.style.left = `${startLeft}px`;

        // 랜덤 속도 (3~7초)
        const duration = 3 + Math.random() * 4;
        parachute.style.animationDuration = duration + "s";

        // 바람 방향: -1(왼쪽), 0(직진), 1(오른쪽)
        const wind = Math.random();
        let windDir = 0;
        if (wind < 0.33) windDir = -1;
        else if (wind > 0.66) windDir = 1;
        // 이동 거리: 100~400px 랜덤
        const windDist = (100 + Math.random() * 300) * windDir;

        // 애니메이션을 JS로 직접 제어 (transform 사용)
        const anim = parachute.animate(
          [
            {
              top: -height + "px",
              left: startLeft + "px",
              transform: "rotate(0deg)",
            },
            {
              top: "110vh",
              left: startLeft + windDist + "px",
              transform: `rotate(${windDir * 20}deg)`,
            },
          ],
          {
            duration: duration * 1000,
            easing: "linear",
            fill: "forwards",
          }
        );

        area.appendChild(parachute);

        // 클릭 시 폭발 + 카운트 증가 + 낙하산 제거
        parachute.addEventListener("click", function (e) {
          e.stopPropagation();
          e.preventDefault();
          if (parachute._clicked) return;
          parachute._clicked = true;
          const rect = parachute.getBoundingClientRect();
          const x = rect.left + rect.width / 2;
          const y = rect.top + rect.height / 2;
          showExplosion(
            x,
            y,
            Math.max(parachute.width, parachute.height) * 1.1
          );
          parachute.remove();
          killCount++;
          // ★ 처음 클릭 시 kill-counter 보이게
          const killCounter = document.getElementById("kill-counter");
          if (killCounter.style.display === "none") {
            killCounter.style.display = "block";
          }
          document.getElementById("kill-count").textContent = killCount;

          // ★ 5킬 초과 시 게임 하러 가기 버튼 등장
          if (killCount > 5 && !goPlayShown) {
            goPlayShown = true;
            const btn = document.getElementById("go-play-btn");
            btn.classList.add("show");
          }
        });

        // 애니메이션 끝나면 제거
        setTimeout(() => {
          parachute.remove();
        }, duration * 1000 + 100);
      }

      // 0.5~1.2초마다 무작위로 낙하산 생성 (겹침 허용)
      setInterval(() => {
        if (Math.random() < 0.7) {
          spawnParachute();
        }
      }, 500 + Math.random() * 700);
    </script>
    <script>
      $(function () {
        // 파티클 효과를 위한 캔버스 추가 (body 전체에 오버레이)
        if ($("#power-canvas").length === 0) {
          $("body").append(
            '<canvas id="power-canvas" style="position:fixed;left:0;top:0;width:100vw;height:100vh;pointer-events:none;z-index:9999;"></canvas>'
          );
        }
        const canvas = document.getElementById("power-canvas");
        const ctx = canvas.getContext("2d");
        let W = 0,
          H = 0;
        const DPR = Math.max(1, window.devicePixelRatio || 1);

        function resizeCanvas() {
          W = window.innerWidth;
          H = window.innerHeight;
          canvas.width = W * DPR;
          canvas.height = H * DPR;
          canvas.style.width = W + "px";
          canvas.style.height = H + "px";
          ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
        }
        resizeCanvas();
        window.addEventListener("resize", resizeCanvas);

        // 파티클 엔진 (주황→노랑 그라데이션)
        const COLORS = [
          "#ff9800", // 주황
          "#ffc107", // 밝은 주황
          "#ffd700", // 노랑
          "#fff176", // 밝은 노랑
        ];
        const GRAVITY = 0.12,
          FRICTION = 0.96,
          PARTICLE_BASE = 8;

        let particles = [];
        function spawn(x, y, amount = PARTICLE_BASE, power = 1200) {
          for (let i = 0; i < amount; i++) {
            const ang = Math.random() * Math.PI * 2;
            const spd = power * (0.8 + Math.random() * 50);
            // 주황~노랑 그라데이션 색상 랜덤 적용
            const color = COLORS[Math.floor(Math.random() * COLORS.length)];
            particles.push({
              x,
              y,
              vx: Math.cos(ang) * spd,
              vy: Math.sin(ang) * spd - 8,
              life: 1200 + Math.random() * 300,
              r: 16 + Math.random() * 3.5,
              color: color,
            });
          }
        }
        const BULLET_IMG = new Image();
        BULLET_IMG.src = "pngegg.png"; // 총알 PNG 파일 경로(투명 배경, 작은 사이즈 추천)

        function loop() {
          ctx.clearRect(0, 0, W, H);
          for (let i = particles.length - 1; i >= 0; i--) {
            const p = particles[i];
            if (!p.prev) p.prev = { x: p.x, y: p.y };
            p.vx *= FRICTION;
            p.vy = p.vy * FRICTION + GRAVITY;
            p.x += p.vx;
            p.y += p.vy;
            p.life -= 1;
            const a = Math.max(0, Math.min(1, p.life / 1200));
            ctx.globalAlpha = a;

            // 모든 파티클을 총알 이미지로 그림 (트레일 대신)
            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate(Math.atan2(p.vy, p.vx)); // 이동 방향에 따라 회전
            ctx.drawImage(BULLET_IMG, -p.r, -p.r, p.r * 2, p.r * 2);
            ctx.restore();

            p.prev = { x: p.x, y: p.y };
            if (p.life <= 0 || p.x < -50 || p.x > W + 50 || p.y > H + 50)
              particles.splice(i, 1);
          }
          ctx.globalAlpha = 1;
          requestAnimationFrame(loop);
        }
        requestAnimationFrame(loop);

        // 입력창에서 커서 위치 구하기 (화면 전체 기준)
        function caretInInput(el) {
          const isInput = el.tagName === "INPUT";
          const div = document.createElement("div");
          const cs = getComputedStyle(el);
          [
            "font-size",
            "font-family",
            "font-weight",
            "font-style",
            "letter-spacing",
            "text-transform",
            "text-indent",
            "text-align",
            "line-height",
            "padding-top",
            "padding-right",
            "padding-bottom",
            "padding-left",
            "border-top-width",
            "border-left-width",
            "box-sizing",
            "white-space",
            "word-wrap",
            "overflow-wrap",
            "width",
            "height",
          ].forEach((p) => (div.style[p] = cs[p]));
          div.style.position = "absolute";
          div.style.visibility = "hidden";
          div.style.whiteSpace = isInput ? "pre" : "pre-wrap";
          div.style.wordWrap = "break-word";
          const before = el.value.substring(0, el.selectionStart);
          const afterChar = el.value.substring(el.selectionStart)[0] || ".";
          div.textContent = before;
          const span = document.createElement("span");
          span.textContent = afterChar;
          div.appendChild(span);
          el.parentNode.appendChild(div);
          const sRect = span.getBoundingClientRect();
          el.parentNode.removeChild(div);

          // 화면 전체 기준 좌표로 반환 (조정: 오른쪽+12, 위쪽-30)
          const x = sRect.left + 20;
          const y = sRect.top - 20;
          return { x: x, y: y };
        }

        // input, textarea, contenteditable에 효과 적용
        $(
          ".center-top-box input[type='text'], .center-top-box textarea, .center-top-box [contenteditable]"
        ).on("keydown", function (e) {
          const pos = caretInInput(this);
          if (!pos) return;
          const boost = e.key === "Enter" ? 20 : 0;
          if (e.key === "Backspace") {
            // 백스페이스일 때 랜덤 흔들림 효과 추가
            const $box = $(".center-top-box");
            // 랜덤 방향 값 생성 (좌우, 위아래, 대각선)
            const shakeX = Math.round((Math.random() - 0.5) * 16); // -8~8px
            const shakeY = Math.round((Math.random() - 0.5) * 16); // -8~8px
            const shakeX2 = Math.round((Math.random() - 0.5) * 10); // -5~5px
            const shakeY2 = Math.round((Math.random() - 0.5) * 10); // -5~5px
            $box[0].style.setProperty("--shake-x", `${shakeX}px`);
            $box[0].style.setProperty("--shake-y", `${shakeY}px`);
            $box[0].style.setProperty("--shake-x2", `${shakeX2}px`);
            $box[0].style.setProperty("--shake-y2", `${shakeY2}px`);
            $box.removeClass("shake");
            void $box[0].offsetWidth;
            $box.addClass("shake");
            setTimeout(() => $box.removeClass("shake"), 150);
            return;
          }
          const pow = e.key === "Backspace" ? 0 : 2.3;
          spawn(pos.x, pos.y, PARTICLE_BASE + boost, pow);
        });
      });
    </script>
    <script>
      $(function () {
        // 시작 버튼 클릭 시 center-top-box 활성화, 버튼 숨김, 음악 재생
        $("#start-search-btn").on("click", function () {
          $(this).fadeOut(300, function () {
            $(".center-top-box").fadeIn(300);
          });
          // 음악 재생 (브라우저 정책 대응)
          const bgm = document.getElementById("bgm");
          if (bgm) {
            bgm.play();
          }
        });
      });
    </script>
    <script>
      $(function () {
        // 크롤러 효과: center-top-box 내부에서 병사들이 기어다님
        const CONFIG = {
          count: 5,
          size: 38,
          speedMin: 30,
          speedMax: 60,
          edgeOffset: -6
        };
        const $box = $(".center-top-box");
        const layer = document.getElementById("crawler-layer");

        class Soldier {
          constructor(opts){
            this.t = Math.random();
            this.clockwise = Math.random() > 0.5;
            this.speed = opts.speed;
            this.size = opts.size;
            this.w = 0; this.h = 0; this.perimeter = 0;
            this.el = document.createElement('div');
            this.el.className = 'crawler';
            this.el.style.width = this.el.style.height = this.size + 'px';
            const inner = document.createElement('div');
            inner.className = 'human';
            inner.innerHTML = this._svgHuman();
            this.el.appendChild(inner);
            layer.appendChild(this.el);
          }
          _svgHuman(){
            return `
              <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M26 16a10 10 0 0 1 12 0l4 3-2 5H24l-2-5 4-3z" fill="#0f172a"/>
                <rect class="torso" x="29" y="24" width="6" height="14" rx="2" fill="#1f2937"/>
                <rect class="limb armL" x="18" y="27" width="14" height="4" rx="2" fill="#334155" transform="rotate(-30 25 29)"/>
                <rect class="limb armR" x="32" y="26" width="14" height="4" rx="2" fill="#334155" transform="rotate(25 39 28)"/>
                <rect class="limb legL" x="22" y="38" width="16" height="4" rx="2" fill="#334155" transform="rotate(12 30 40)"/>
                <rect class="limb legR" x="34" y="42" width="16" height="4" rx="2" fill="#334155" transform="rotate(-12 42 44)"/>
              </svg>`;
          }
          updatePath(){
            this.w = $box.width();
            this.h = $box.height();
            this.perimeter = 2 * (this.w + this.h);
          }
          step(dt){
            if (!this.perimeter) this.updatePath();
            const dPix = this.speed * dt * (this.clockwise ? 1 : -1);
            let d = (this.t * this.perimeter + dPix) % this.perimeter; if (d < 0) d += this.perimeter; this.t = d / this.perimeter;
            const p = this._pointOnRect(d);
            this.el.style.transform = `translate(${p.x}px, ${p.y}px) rotate(${p.angle}deg)`;
          }
          _pointOnRect(d){
            const eo = CONFIG.edgeOffset, half = this.size/2;
            const w = this.w, h = this.h;
            const left = half - eo, top = half - eo, right = w - half + eo, bottom = h - half + eo;
            const topLen = w, rightLen = h, bottomLen = w, leftLen = h;
            if (d <= topLen) { return { x: left + d, y: top, angle: 0 } }
            else if (d <= topLen + rightLen) { return { x: right, y: top + (d - topLen), angle: 90 } }
            else if (d <= topLen + rightLen + bottomLen) { return { x: right - (d - topLen - rightLen), y: bottom, angle: 180 } }
            else { return { x: left, y: bottom - (d - topLen - rightLen - bottomLen), angle: 270 } }
          }
        }

        let rafId = null, running = true, crawlers = [];
        function spawn(n){
          for (let i = 0; i < n; i++){
            const speed = CONFIG.speedMin + Math.random() * (CONFIG.speedMax - CONFIG.speedMin);
            const size  = CONFIG.size + Math.round(Math.random() * 8);
            const s = new Soldier({ speed, size }); s.t = Math.random(); crawlers.push(s);
          }
          updateAllPaths();
        }
        function updateAllPaths(){ crawlers.forEach(s => s.updatePath()); }
        function tick(tNow){
          if (!running) { rafId = null; return; }
          if (!tick.last) tick.last = tNow; const dt = Math.min(0.05, (tNow - tick.last) / 1000); tick.last = tNow;
          crawlers.forEach(s => s.step(dt));
          rafId = requestAnimationFrame(tick);
        }
        // 반응형
        new ResizeObserver(updateAllPaths).observe($box[0]);
        // 크롤러 분대 생성 및 애니메이션 시작
        spawn(CONFIG.count); running = true; tick.last = 0; tick(performance.now());
      });
    </script>
  </body>
</html>
